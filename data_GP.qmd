---
title: "Data Group Project"
author: "Victoire Truchon Bartes & Emmanuel de MOREL"
format: html
---

Here the link to the github project : https://github.com/EmmDM/M1_QE_data_group_project

Here the links to the original sources : For the OECD : https://stats.oecd.org/index.aspx?lang=fr&datasetcode=green_growth

And for the World Bank : https://donnees.banquemondiale.org/theme/changement-climatique


```{r}
#Séléction des librairies
library(here)
library(dplyr)
library(tidyr)
library(knitr)
library(ggplot2)
library(readr)
library(stringr)
library(readxl)
```

```{r}
here :: i_am("M1_QE_data_group_project.Rproj")
OCDE_GG <-read.csv(here("OCDE_GREEN_GROWTH.csv" ), sep = ";")
Worldbank <- read_xls("Worldbank.xls")

#Nettoyage base de données OCDE

OCDE_GG <- OCDE_GG %>% select(-`YEA`,-`PowerCode.Code`, -`Reference.Period.Code`,-`Reference.Period`, -`Unit.Code`)
OCDE_GG <- OCDE_GG %>% pivot_wider(names_from= `Année`, values_from =  `Value`)
OCDE_GG <- OCDE_GG %>% select(-`2021`, -`2022`) #On supprime les données 2021 et 2022 car il y a un manque de données

#Nettoyage base de données World Bank

Worldbank <- Worldbank %>% select(-`1960`,-`1961`,-`1962`,-`1963`,-`1964`,-`1965`,-`1966`,-`1967`,-`1968`,-`1969`,-`1970`,-`1971`,-`1972`,-`1973`,-`1974`,-`1975`,-`1976`,-`1977`,-`1978`,-`1979`,-`1980`,-`1981`,-`1982`,-`1983`,-`1984`,-`1985`,-`1986`,-`1987`,-`1988`,-`1989`,-`2021`, -`2022`) #On conserve seulement période de 1990 à 2020 afin de faire des comparaisons avec les données de l'OCDE. On supprime les données 2021 et 2022 car il y a un manque de données

#Je renomme les colonnes qui ont la même fonction mais des noms différents
Worldbank <- Worldbank %>% rename ("COU" = "Country Code", "Pays" = "Country Name","Variable" = "Indicator Name", "VAR" = "Indicator Code")

```

```{r}
# On détermine le nombre de colonnes, de lignes, de pays et de variables dans chacune des bases de données initiales
info_OCDE_GG <- OCDE_GG %>% summarise(ligne = nrow(.), colonne = ncol(.), Pays = n_distinct(COU, na.rm = TRUE), Variables = n_distinct(Variable, na.rm = TRUE))
info_Worldbank <- Worldbank %>% summarise("ligne" = nrow(Worldbank),"colonne" = ncol(Worldbank ), Pays = n_distinct(COU, na.rm = TRUE), Variables = n_distinct(Variable, na.rm = TRUE))

knitr :: kable(info_OCDE_GG, caption = "Information tableau de l'OCDE")
knitr :: kable(info_Worldbank, caption = "Information tableau de la World Bank")
```

```{r} 
# Tri des variables base de données OCDE

Variables_to_select <- c(
  "Productivité CO2 induite par la production, PIB par unité d'émission de CO2 liée à l'énergie",
  "Intensité CO2 induite par la production, émissions de CO2 liées à l'énergie, par habitant",
  "Émissions de CO2 induites par la production",
  "Intensité énergétique, ATE par habitant",
  "Énergies renouvelables, % approvisionnement total en énergie",
  "Électricité renouvelable, % de la production électrique totale",
  "Exposition moyenne de la population aux PM2.5",
  "Pourcentage de la population exposée à plus de 10 microgrammes/m3",
  "Développement de technologies liées à l'environnement, % inventions dans le monde",
  "Développement de technologies liées à l'environnement, inventions par habitant",
  "Recettes provenant des taxes liées à l'énergie, % recettes des taxes environnementales",
  "Soutien aux consommateurs de combustibles fossiles, % recettes totales des taxes",
  "Soutien au pétrole, % soutien total aux combustibles fossiles",
  "Soutien à l'électricité, % soutien total aux combustibles fossiles",
  "Soutien total aux combustibles fossiles, % recettes totales des taxes",
  "Zone marine protégée, % zone économique exclusive totale",
  "Zone terrestre protégée, % surface terrestre",
  "PIB réel",
  "PIB réel par habitant",
  "Migration nette",
  "Consommation d'énergie par l'industrie, % consommation totale d'énergie",
  "Consommation d'énergie par l'agriculture, % consommation totale d'énergie",
  "Consommation d'énergie par les autres secteurs, % consommation totale d'énergie",
  "Productivité énergétique, PIB par unité d'ATE",
  "PIB par unité d'ATE",
  "Approvisionnements totaux en énergie",
  "Prélèvements bruts d'eau douce par habitant",
  "Stress hydrique, total des prélèvements d'eau douce en % des ressources internes renouvelables",
  "Pourcentage de la population exposée à plus de 35 microgrammes/m3",
  "Mortalité due à l'exposition aux PM2.5",
  "Coûts en bien-être dus à l'exposition aux PM2.5, PIB équivalent",
  "Pourcentage de la population exposée aux journées chaudes",
  "Pourcentage de la population exposée aux journées glacées",
  "Pourcentage de la population exposée aux inondations fluviales",
  "Pourcentage de la population exposée aux incendies incontrôlés"
)

OCDE_GG <- OCDE_GG %>%
  filter(Variable %in% Variables_to_select)

# Tri des variables base de données World bank

# Define the variables to select
indicators_to_select <- c(
  "Population urbaine (% du total)",
  "Population urbaine",
  "Croissance de la population urbaine (% annuel)",
  "Population, total",
  "Croissance de la population (% annuel)",
  "Agriculture, valeur ajoutée (% du PIB)",
  "Zones terrestres et marines protégées (% du territoire total)",
  "Zones marines protégées (% des eaux du territoire)",
  "Émissions/éliminations nettes de GES attribuables au changement d'affectation des terres et à la foresterie (Mt d’équivalents CO2)",
  "Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)",
  "Émissions totales de GES (variation depuis 1990, %)",
  "Émissions totales de GES (kt d’équivalent CO2)",
  "Zones protégées à l'échelle nationale (% du territoire total)",
  "Retraits annuels d’eau douce, total (% des ressources internes)",
  "Retraits annuels d’eau douce, total (milliards de mètres cubes)",
  "Autres émissions de gaz à effet de serre, HFC, PFC et SF6 (milliers de tonnes métriques d’équivalent CO2)",
  "Émissions de CO2 (tonnes métriques par habitant)",
  "Sécheresses, inondations, températures extrêmes (en % de la population, moyenne de 1990 à 2009)",
  "Émissions de CO2 (kg par $ US de 2010 de PIB)",
  "Intensité en CO2 (kg par kg d’utilisation d’énergie en équivalent pétrole)",
  "Utilisation d’énergie (kg d’équivalent pétrole par habitant)",
  "Consommation d’électricité (KWh par habitant)",
  "Utilisation d’énergie (en kg d’équivalent pétrole) pour 1 000 $ de PIB (PPA constants de 2011)",
  "Consommation d’énergies renouvelables (% de la consommation totale d’énergie)",
  "Production d’électricité à partir de sources d’énergie renouvelables, hors énergie hydroélectrique (% du total)",
  "Production d’électricité à partir de sources d’énergie renouvelables, hors énergie hydroélectrique (kWh)",
  "Accès à l’électricité (% de la population)",
  "Hauteur moyenne des précipitations (mm par an)",
  "Terres agricoles (km carrés)",
  "Émissions de CO2 (kg par $ PPA de 2011 de PIB)",
  "Émissions de CO2 (kt)",
  "Production d’électricité renouvelable (% de la production totale d’électricité)",
  "Production d’électricité à partir de sources pétrolières (% du total)",
  "Production d’électricité à partir de sources nucléaires (% du total)",
  "Production d’électricité à partir de sources de gaz naturel (% du total)",
  "Production d’électricité à partir de sources de gaz naturel (% du total)",
  "Production d’électricité à partir de sources de charbon (% du total)",
  "Surface forestière (% du territoire)",
  "Terres agricoles (% du territoire)",
  "Population vivant sur des terres dont l’altitude est inférieure à 5 mètres (en % de la population totale)",
  "Zones urbaines dont l’altitude est < à 5 m (% de la superficie totale)",
  "Superficie des terres dont l’altitude est inférieure à 5 mètres (en % de la superficie totale des terres)"
)

# Filter the worldbank dataset
Worldbank <- Worldbank %>%
  filter(`Variable` %in% indicators_to_select)


```

```{r}
#Verification du nombre de variable pour chaque base de données
 WB_variable <- Worldbank %>% distinct(`Variable`) %>% summarize(`Variable` = n())
 OCDE_variable <- OCDE_GG %>% distinct(Variable) %>% summarize(`Variable` = n())
 print(WB_variable)
 print(OCDE_variable)

```


```{r}
# On cherche si certains pays n'apparaissent pas dans l'une des bases de données. J'utilise les codes pays pour vérifier

codes_pays_OCDE <- OCDE_GG %>% select(`COU`, `Pays`) %>% distinct(COU,.keep_all = TRUE)

codes_pays_Worldbank <- Worldbank %>% select(`COU`, `Pays`) %>% distinct (`COU`, .keep_all = TRUE)

codes_pays_manquants_OCDE <- anti_join(codes_pays_OCDE,codes_pays_Worldbank, by = c("COU" = "COU"))
codes_pays_manquants_Worldbank <- anti_join(codes_pays_Worldbank,codes_pays_OCDE, by = c("COU" = "COU" ))

#Afin d'avoir les mêmes pays, on supprime ensuite les pays manquants des bases de données origniales

Worldbank <- anti_join(Worldbank,codes_pays_manquants_Worldbank, by = ("COU"))
OCDE_GG <- anti_join(OCDE_GG,codes_pays_manquants_OCDE, by = ("COU"))

#Je compte le nombre de pays dans chaque base de données
OCDE_count_ry <- OCDE_GG %>% distinct(COU) %>% summarize(`COU` = n())
WB_count_ry <- Worldbank %>% distinct(`COU`) %>% summarize(`COU` = n())
# Il y a 206 pays dans chacune des bases



```

```{r}
#On compare les noms des pays afin de les renommer si leur nom est différent
#Je fusionne les deux dataframe contenant les codes pays
codes_pays <- merge(codes_pays_OCDE, codes_pays_Worldbank,all = TRUE)

#J'identifie les codes pays qui apparaissent deux fois
codes_pays_supprimer <- codes_pays %>% group_by(COU) %>% filter(n() == 2) %>% pull(COU)

#Je supprime une des lignes où le code pays apparaît deux fois
codes_pays_fin <- codes_pays %>% group_by(COU) %>% slice(if (n() == 2) 2 else 1)


```


```{r}
#On compare les noms des pays afin de les renommer si leur nom est différent

#Je fusionne les deux bases de données, OCDE et Worldbank
dataframe <- merge(OCDE_GG,Worldbank, all = TRUE)

dataframe <- dataframe %>% select(-`Pays`)
dataframe_new <- merge(dataframe,codes_pays_fin, by = c("COU"))
dataframe_new <- dataframe_new %>% select("COU","Pays","VAR","Variable","Unit","PowerCode","1990","1991","1992","1993","1994","1995","1996","1997","1998","1999","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020")
```

```{r}
#Vérifie que le nombre de variable reste identique
WB_variable <- Worldbank %>% distinct(`Variable`) %>% summarize(`Variable` = n())
OCDE_variable <- OCDE_GG %>% distinct(Variable) %>% summarize(`Variable` = n())
dataframe_variable <- dataframe %>% distinct(Variable) %>% summarize(`Variable` = n())
dataframe_new_variable <- dataframe_new %>% distinct(Variable) %>% summarize(`Variable` = n())
print(WB_variable)
print(OCDE_variable)
print(dataframe_variable)
print(dataframe_new_variable)
```

```{r}
# On effectue une base des pays membres de l'OCDE
OCDE_to_select <- c("Allemagne",	"Australie","Autriche","Belgique","Canada","Chili","Colombie","Corée, République de","Costa Rica","Danemark","Espagne","Estonie","États-Unis","Finlande","France","Grèce","Hongrie","Irlande","Islande","Israël","Italie","Japon","Lettonie","Lituanie","Luxembourg","Mexique","Norvège","Nouvelle-Zélande","Pays-Bas","Pologne","Portugal","République slovaque","Tchéquie","Royaume-Uni","Slovénie","Suède","Suisse","Turquie")

OCDE_pays <- dataframe_new %>% filter(`Pays` %in% OCDE_to_select)

# On effectue une base de données des pays non membres de l'OCDE
non_OCDE_pays <- dataframe_new %>%  filter(!(`Pays` %in% OCDE_to_select))

```


```{r}
# On détermine le nombre de colonnes, de lignes, de pays et de variables dans chacune des bases de données finales
info_OCDE_pays <- OCDE_pays %>% summarise(ligne = nrow(.), colonne = ncol(.), Pays = n_distinct(COU, na.rm = TRUE), Variables = n_distinct(Variable, na.rm = TRUE))
info_non_OCDE_pays <- non_OCDE_pays %>% summarise(ligne = nrow(.),colonne = ncol(.), Pays = n_distinct(COU, na.rm = TRUE), Variables = n_distinct(Variable, na.rm = TRUE))

knitr :: kable(info_OCDE_pays, caption = "Information tableau des pays membres l'OCDE")
knitr :: kable(info_non_OCDE_pays, caption = "Information tableau des pays non membres de l'OCDE")
```

```{r}
var_OCDE <- OCDE_pays %>% select(`Variable`) %>% distinct(Variable,.keep_all = TRUE)

var_non_OCDE <- non_OCDE_pays %>% select(`Variable`) %>% distinct (`Variable`, .keep_all = TRUE)

var_manquants_OCDE <- anti_join(var_OCDE,var_non_OCDE, by = c("Variable" = "Variable"))
var_manquants_non_OCDE <- anti_join(var_non_OCDE ,var_OCDE, by = c("Variable" = "Variable" ))

knitr :: kable(var_manquants_OCDE)
knitr :: kable(var_manquants_non_OCDE)

# On constate que certaines variables ne sont présentes que pour les pays de l'OCDE (Pourcentage de la population exposée aux incendies incontrôlés,Pourcentage de la population exposée aux journées chaudes, Pourcentage de la population exposée aux journées glacées, Pourcentage de la population exposée aux inondations fluviales, Stress hydrique, total des prélèvements d’eau douce en % des ressources internes renouvelables). Elles pourront pas être utilisées comme comparaison avec les pays non membre de l'organisation
```

