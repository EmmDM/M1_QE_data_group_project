---
title: "Final Part"
author: "Victoire Truchon-Bartès & Emmanuel de MOREL"
format: html
echo : false
editor: 
  markdown: 
    wrap: 72
---

```{r, echo=FALSE}
# Sélection des librairies
suppressWarnings({suppressMessages(library(here))
suppressMessages(library(dplyr))
library(tidyr)
library(knitr)
library(ggplot2)
library(readr)
library(stringr)
library(readxl)})
```

```{r}
#On lit les bases de données OCDE_pays et non_OCDE_pays
donnees_partage <- readRDS("donnees_partage.RDS")
OCDE_pays <- donnees_partage$OCDE_pays
non_OCDE_pays <- donnees_partage$non_OCDE_pays
```

```{r}
#Pour les GES
#Tous les pays de l'OCDE et les trois régions principales (Europe, Amérique du Nord et Pacifique)
#Variables : PIB par habitant / Emission de GES
decoupling_CO2_OCDE <-  OCDE_pays %>% filter(Variable %in% c("PIB réel","Émissions totales de GES (kt d’équivalent CO2)","Population, total")) %>% select(-`COU`, -`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 

#Création d'un index 
CO2_total_OCDE_index <- decoupling_CO2_OCDE %>% filter(Pays%in%unique(decoupling_CO2_OCDE$Pays)) %>% group_by(Année) %>% summarise(PIB_tot = sum(`PIB réel`, na.rm = TRUE)*1000000, Hab_tot = sum(`Population, total`,na.rm = TRUE), GES_tot = sum(`Émissions totales de GES (kt d’équivalent CO2)`, na.rm = TRUE)) %>% mutate(PIB_hab = `PIB_tot`/`Hab_tot`)

CO2_total_OCDE <- CO2_total_OCDE_index %>% group_by(Année) %>% summarise(Ratio = `GES_tot`/`PIB_hab`)
CO2_total_OCDE <- CO2_total_OCDE %>% mutate(Ratio_base100 = Ratio / Ratio[which(CO2_total_OCDE$Année == 1990)]*100)


#Tous les pays NON membres de l'OCDE 
#Variables : PIB par habitant / Emission de GES
decoupling_CO2_non_OCDE <-  non_OCDE_pays %>% filter(Variable %in% c("PIB réel","Émissions totales de GES (kt d’équivalent CO2)", "Population, total")) %>% select(-`COU`, -`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 

#On crée un indice
CO2_total_non_OCDE_index <- decoupling_CO2_non_OCDE %>% filter(Pays%in%unique(decoupling_CO2_non_OCDE$Pays)) %>% group_by(Année) %>% summarise(PIB_tot = sum(`PIB réel`, na.rm = TRUE)*1000000, Hab_tot = sum(`Population, total`,na.rm = TRUE), GES_tot = sum(`Émissions totales de GES (kt d’équivalent CO2)`, na.rm = TRUE)) %>% mutate(PIB_hab = `PIB_tot`/`Hab_tot`)

CO2_total_non_OCDE <- CO2_total_non_OCDE_index %>% group_by(Année) %>% summarise(Ratio = `GES_tot`/`PIB_hab`) 

CO2_total_non_OCDE <- CO2_total_non_OCDE %>% mutate(Ratio_base100 = Ratio / Ratio[which(CO2_total_non_OCDE$Année == 1990)]*100)

```

# I. Constat sur la transition écologique

```{r}
#On va faire des graphs en considérant la croissance du PIB et la croissance des émissions
#On s'intéresse aux pays membres de l'OCDE
#On calcule les taux de croissance par an du PIB réel par habitant et des Émissions totales de GES (kt d’équivalent CO2)

#OCDE
decoupling_CO2_OCDE_growth <- CO2_total_OCDE_index %>% mutate(taux_PIB = ((`PIB_hab` - lag( `PIB_hab`)) *100/lag( `PIB_hab`)), taux_CO2 = ((`GES_tot` - lag( `GES_tot`))*100 /lag( `GES_tot`)))

decoupling_CO2_OCDE_growth_convert <- decoupling_CO2_OCDE_growth %>% pivot_longer(cols = c(taux_PIB,taux_CO2), names_to = "Variable", values_to = "Taux") 

ggplot(decoupling_CO2_OCDE_growth_convert, aes(x = Année, y = Taux, color = Variable, linetype = Variable, group = Variable)) + geom_point(na.rm = TRUE)  + geom_line(na.rm = TRUE) + labs(title = "Taux de croissance du PIB par habitant  \n et taux de croissance des émissions de CO2 des pays membres de l'OCDE", x = "Année", y = "Taux de croissance (%)", color = "Variable") +  theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5))

#Non OCDE
decoupling_CO2_non_OCDE_growth <- CO2_total_non_OCDE_index %>% mutate(taux_PIB = ((`PIB_hab` - lag( `PIB_hab`)) *100/lag( `PIB_hab`)), taux_CO2 = ((`GES_tot` - lag( `GES_tot`))*100 /lag( `GES_tot`)))

decoupling_CO2_non_OCDE_growth_convert <- decoupling_CO2_non_OCDE_growth %>% pivot_longer(cols = c(taux_PIB,taux_CO2), names_to = "Variable", values_to = "Taux")

# Représentation des graphiques considérant la croissance du PIB et la croissance des émissions
#On s'intéresse aux pays non membres de l'OCDE
ggplot(decoupling_CO2_non_OCDE_growth_convert, aes(x = Année, y = Taux, color = Variable, linetype = Variable, group = Variable)) + geom_point(na.rm = TRUE)  + geom_line(na.rm = TRUE) + labs(title = "Taux de croissance du PIB par habitant \n et taux de croissance des émissions de CO2 des pays non membres de l'OCDE", x = "Année", y = "Taux de croissance (%)", color = "Variable") +  theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5))  
```

```{r}
reg_CO2_PIB_OCDE=lm('taux_CO2 ~ taux_PIB', data = decoupling_CO2_OCDE_growth)
summary(reg_CO2_PIB_OCDE)
ggplot(reg_CO2_PIB_OCDE, aes(x = taux_PIB,y = taux_CO2)) + geom_point(color='gray', size=1, na.rm = TRUE) + geom_smooth(method='lm', formula = 'y ~ x', se=FALSE, color='red', na.rm = TRUE) + theme_minimal() + labs(title = "Taux de croissance du PIB par habitant et taux de croissance des émissions de CO2 des pays membres de l'OCDE", x = "Taux de croissance du PIB/hab (%)", y = "Taux de croissance des émissions de GES (%)")

reg_CO2_PIB_non_OCDE=lm('taux_CO2 ~ taux_PIB', data = decoupling_CO2_non_OCDE_growth)
summary(reg_CO2_PIB_non_OCDE)
ggplot(reg_CO2_PIB_non_OCDE, aes(x = taux_PIB,y = taux_CO2)) + geom_point(color='gray', size=1, na.rm = TRUE) + geom_smooth(method='lm',formula = 'y ~ x', se=FALSE, na.rm = TRUE) +  labs(title = "Taux de croissance du PIB par habitant et taux de croissance des émissions de CO2 des pays non membres de l'OCDE", x = "Taux de croissance du PIB/hab (%)", y = "Taux de croissance des émissions de GES (%)") + theme_minimal() 

```

## *A) Découplage*

Le découplage se produit lorsque le taux de croissance d'une pression
environnementale est inférieur à celui de sa force motrice économique
(par exemple le PIB) sur une période donnée. Le découplage peut être
absolu ou relatif. On parle de découplage absolu lorsque la variable
pertinente pour l'environnement est stable ou décroissante alors que la
force motrice économique augmente. Le découplage est dit relatif lorsque
le taux de croissance de la variable pertinente pour l'environnement est
positif, mais inférieur au taux de croissance de la variable économique.
Il existe un nombre varié d'indicateur de découplage, dans cette
présentation nous focaliserons sur les emissions totales de gaz à effet
de serre (GES) par unité de PIB et par personne. La manière la plus
directe d'afficher le découplage entre une pression environnementale et
une force économique consiste à tracer deux séries temporelles indexées
(par exemple 1980 = 100) sur le même graphique. A partir d'un tel
graphique, il est immédiatement clair si une force économique croit ou
décroit, si le découplage -absolu ou relatif- s'opère et quand il
commence et s'il continue.

Pour comparer le découplage parmi les pays, le ratio de la valeur du
découplage à la fin et au début d'une période de temps donnée est
définie comme :
$$ Ratio = {(PE/FM)_{findepériode} / (PE/FM)_{débutdepériode}} $$

avec : PE = Pression environnementale et FM = Force motrice

```{r}
#Representation graphique de l'indice de découplage entre les émissions de GES et le PIB/hab pour l'ensemble des pays membres de l'OCDE
ggplot(CO2_total_OCDE, aes(x = Année, y = Ratio_base100))  + geom_point() + labs(title = "Emissions par unité de PIB et par personne en base 100 (1990) pour le total de l'OCDE", x = "Année", y = "Ratio (Base 100 en 1990)") + theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5)) 

#Representation graphique de l'indice de découplage entre les émissions de GES et le PIB/hab pour l'ensemble des pays NON membres de l'OCDE
ggplot(CO2_total_non_OCDE, aes(x = Année, y = Ratio_base100))  + geom_point() + labs(title = "Emissions par unité de PIB et par personne en base 100 (1990) pour le total des pays non membres de l'OCDE", x = "Année", y = "Ratio (Base 100 en 1990)") + theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5)) 


#Fusion des deux graphiques
CO2_fusion <- bind_rows(mutate(CO2_total_OCDE, Group = "OCDE"), mutate(CO2_total_non_OCDE, Group = "Non-OCDE"))

ggplot(CO2_fusion, aes(x = Année, y = Ratio_base100, color = Group)) + geom_point() +  labs(title = "Emissions par unité de PIB et par personne en base 100 (1990)", x = "Année", y = "Ratio (Base 100 en 1990)") + theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5)) 

```

```{r}
#Ici le but est de réaliser un diagramme en nuage de point avec en abscisse le taux de croissance du PIB en pourcentage en 2020 depuis 1990 et en ordonnées le taux de croisssance des émissions de GES en pourcentage en 2020 depuis 1990. Cela nous permettra de distinguer les pays qui ont on effectué un découplage et de de quel type de découplage il s'agit


#OCDE
decoupling_final <- decoupling_CO2_OCDE %>% group_by(Année, Pays) %>% summarise(PIB_tot = sum(`PIB réel`, na.rm = TRUE)*1000000, Hab_tot = sum(`Population, total`,na.rm = TRUE), GES_tot = sum(`Émissions totales de GES (kt d’équivalent CO2)`, na.rm = TRUE), .groups = 'drop') %>% mutate(PIB_hab = `PIB_tot`/`Hab_tot`)

decoupling_final_convert <- decoupling_final %>% filter(Pays%in%unique(decoupling_final$Pays)) %>% group_by(Pays) %>% summarise(taux_GES_90_20 = (GES_tot[Année == 2020] - GES_tot[Année == 1990])*100/ GES_tot[Année == 1990], taux_PIB_90_20 = (PIB_hab[Année == 2020] - PIB_hab[Année == 1990])*100/ PIB_hab[Année == 1990],  .groups = 'drop')

decoupling_final_convert  <- decoupling_final_convert  %>% filter(!is.infinite(taux_PIB_90_20) & !is.infinite(taux_GES_90_20))
  
graph_decoupling <- ggplot(decoupling_final_convert, aes(x = taux_PIB_90_20,y = taux_GES_90_20)) + geom_point( size=1, na.rm = TRUE)  +  labs(title = "Découplage au sein de l'OCDE", x = "Taux de croissance du PIB/hab en 2020 par rapport à 1990 (%)", y = "Taux de croissance des émissions de GES en 2020 par rapport à 1990 (%)") + theme_minimal() 

graph_decoupling + geom_abline(intercept = 0, slope = 1, color = "black") + geom_abline(intercept = 0, slope = 0, color = "black") + geom_abline(intercept = 0, slope = 0, color = "black") + geom_vline(xintercept = 0, color = "black")

#Non - OCDE
decoupling_final_non_OCDE <- decoupling_CO2_non_OCDE %>% group_by(Année, Pays) %>% summarise(PIB_tot = sum(`PIB réel`, na.rm = TRUE)*1000000, Hab_tot = sum(`Population, total`,na.rm = TRUE), GES_tot = sum(`Émissions totales de GES (kt d’équivalent CO2)`, na.rm = TRUE),  .groups = 'drop') %>% mutate(PIB_hab = `PIB_tot`/`Hab_tot`)

decoupling_final_convert_non_OCDE <- decoupling_final_non_OCDE %>% filter(Pays%in%unique(decoupling_final_non_OCDE$Pays)) %>% group_by(Pays) %>% summarise(taux_GES_90_20 = (GES_tot[Année == 2020] - GES_tot[Année == 1990])*100/ GES_tot[Année == 1990], taux_PIB_90_20 = (PIB_hab[Année == 2020] - PIB_hab[Année == 1990])*100/ PIB_hab[Année == 1990],.groups = 'drop')

decoupling_final_convert_non_OCDE  <- decoupling_final_convert_non_OCDE  %>% filter(!is.infinite(taux_PIB_90_20) & !is.infinite(taux_GES_90_20))

x_limits <- c(-70,1000)
y_limits <- c(-75,1000)
graph_decoupling_non_OCDE <- ggplot(decoupling_final_convert_non_OCDE, aes(x = taux_PIB_90_20,y = taux_GES_90_20)) + geom_point( size=1, na.rm = TRUE)  +  labs(title = "Découplage des pays non membres de l'OCDE", x = "Taux de croissance du PIB/hab en 2020 par rapport à 1990 (%)", y = "Taux de croissance des émissions de GES en 2020 par rapport à 1990 (%)") + theme_minimal() + coord_cartesian(xlim = x_limits, ylim = y_limits) 

graph_decoupling_non_OCDE + geom_abline(intercept = 0, slope = 1, color = "black") + geom_abline(intercept = 0, slope = 0, color = "black") + geom_abline(intercept = 0, slope = 0, color = "black") + geom_vline(xintercept = 0, color = "black")


```

Les pays dont le point se trouve à gauche de l'axe des ordonnées ou au
dessus de la droite d'équation y = x sont des pays où le découplage n'a
pas eu lieu. Les pays dont le point se trouve en dessous de la droite
d'équation y = x mais au dessus de l'axe des abscisse, sont des pays
ayant effectués un découplage relatif, c'est à dire dont les émissions
de GES ont cru plus lentement que le PIB Les pays dont le point est à
droite de l'axe des ordonnées et en dessous de l'axe des abscisse sont
des pays ayant effectuées un découplage absolue, c'est à dire les pays
dont les émissions de GES ont diminué tandis que le PIB a cru

```{r}
decoupling_table_OCDE <- decoupling_final_convert %>% mutate(decoupling_type = case_when(taux_GES_90_20 > taux_PIB_90_20 ~ "No decoupling", taux_GES_90_20 <= taux_PIB_90_20 & taux_GES_90_20 >= 0 ~"Relative decoupling", taux_GES_90_20 < 0 & taux_PIB_90_20 >= 0 ~ "Absolute decoupling", TRUE ~ "Other"))

decoupling_summary_OCDE <- decoupling_table_OCDE %>% group_by(decoupling_type) %>% summarise(percentage = n()/nrow(decoupling_table_OCDE)*100)

decoupling_table_non_OCDE <- decoupling_final_convert_non_OCDE %>% mutate(decoupling_type = case_when(taux_GES_90_20 > taux_PIB_90_20 ~ "No decoupling", taux_GES_90_20 <= taux_PIB_90_20 & taux_GES_90_20 >= 0 ~"Relative decoupling", taux_GES_90_20 < 0 & taux_PIB_90_20 >= 0 ~ "Absolute decoupling", TRUE ~ "Other"))

decoupling_summary_non_OCDE <- decoupling_table_non_OCDE %>% group_by(decoupling_type) %>% summarise(percentage = n()/nrow(decoupling_table_non_OCDE)*100)


knitr :: kable(decoupling_summary_OCDE, caption = "Part des pays membres de l'OCDE d'après le découplage effectué")

knitr :: kable(decoupling_summary_non_OCDE, caption = "Part des pays non membres de l'OCDE d'après le découplage effectué")
```

I.2 Nous analyserons aussi les tendances en matière d'intensité carbone
et d'efficacité énergétique.

A. Courbe environnementale de Kuznets "Selon l'économiste Éloi Laurent,
spécialiste de la croissance, la source de l'idée de découplage repose
sur la courbe environnementale de Kuznets, théorie construite dans les
années 1990 selon laquelle les dommages environnementaux augmentent dans
les premières phases du développement d'une société, puis reculent alors
que la croissance économique se poursuit" (Wikipedia, découplage
(écologie))

La courbe de Kuznets, dont la forme est U inversé, représente
initiallement l'inégalité économique dans un pays en fonction de son
niveau de développement. C'est selon Grossman et Krueger (1994), que
cette forme de courbe peut être observée dans le domaine de
l'environnement.Le modèle de courbe environnementale de Kuznets (EKC)
postule une relation déterministe entre développement économique et
qualité de l'environnement. Dans la première étape de
l'industrialisation, la pollution augmente rapidement car les individus
sont principalement interessées par leur travail et leur revenus que par
la qualité de l'air et de l'eau. A ce stade, la société est trop pauvre
pour réduire ses émissions, de fait la réglementations environnementales
est trop failbe. Le retournement s'effectue à mesure que les revenus
augmentent. Dès lors, les principaux secteurs industriels deviennent
plus propres, les individus valorisent l'environnement et les
institutions de régulation deviennent plus efficaces. Le long de la
courbe, la pollution se stabilise dans la tranche des revenus moyens,
puis retombe au niveau pré-industriel dans les sociétés développées.

```{r}
#CKE 1990
#En abscisse le PIB par tête et en ordonnées le GES par tête
#PIB_hab, GES_hab
#Fusion OCDE, non_OCDE, group
#ggplot
CKE_1990 <- bind_rows(mutate(decoupling_final, Group = "OCDE"),mutate(decoupling_final_non_OCDE, Group = "Non-OCDE"))
CKE_1990 <- CKE_1990 %>% group_by(Année) %>% mutate(GES_hab = `GES_tot` / `Hab_tot`)
CKE_1990 <- CKE_1990 %>% filter(Pays%in%unique(CKE_1990$Pays)) %>% group_by(Pays, Group) %>% summarise(PIB_hab = PIB_hab[Année == 1990], GES_hab = GES_hab[Année == 1990], .groups = 'drop')

ggplot(CKE_1990, aes(x = PIB_hab, y = GES_hab, color = Group)) + geom_point(na.rm = TRUE) + geom_smooth(method = 'lm', formula = y ~ poly(x, 2), se = FALSE, color = 'darkorange') + labs(title = "Courbe de Kuznets environnementale en 1990", x = "PIB par habitant", y = "Emmission de GES")


#CKE 2020
CKE_2020 <- bind_rows(mutate(decoupling_final, Group = "OCDE"),mutate(decoupling_final_non_OCDE, Group = "Non-OCDE"))
CKE_2020 <- CKE_2020 %>% group_by(Année) %>% mutate(GES_hab = `GES_tot` / `Hab_tot`)
CKE_2020 <- CKE_2020 %>% filter(Pays%in%unique(CKE_2020$Pays)) %>% group_by(Pays, Group) %>% summarise(PIB_hab = PIB_hab[Année == 2020], GES_hab = GES_hab[Année == 2020], .groups = 'drop')

ggplot(CKE_2020, aes(x = PIB_hab, y = GES_hab, color = Group)) + geom_point(na.rm = TRUE) + geom_smooth(method = 'lm', formula = y ~ poly(x, 2), se = FALSE, color = 'darkorange') + labs(title = "Courbe de Kuznets environnementale en 2020", x = "PIB par habitant", y = "Emmission de GES")



```

En utilisant les données des pays pour les emissions de GES et les PIB
par habitant, nous constatons qu'il n'y a pas de courbe en U inversée,
ni en 1990, ni en 2020. En effet, à mesure que le PIB est élevé, les
émissions de GES devraient théoriquement diminuées dans les pays
développées, or ce n'est pas ce qui est observées empiriquement, bien
qu'en 2020 il semble y avoir un seuil aux émissions de GES qui n'étaient
pas constaté en 1990. Toutefois, l'année 2020 est aussi une année
particulière en raison de la pandémie de COVID-19 qui a drastiquement
diminué les émissions de CO2, comme le montre l'un des graphiques
précédent.

I.3 Identité de Kaya

"L'identité de Kaya, relie les émissions anthropique de dioxyde de
carbone à des paramètre d'ordre démographique, économique et
énergétique. \[...\] Selon Kaya, le niveau total d'émission peut
s'exprimer comme le produit de quatres facteurs : la population, le PIB
par habitant, l'intensité énergétique et le contenu en CO2 de l'énergie
consommée. Cette identité se décompose par : CO2 = POP \* (PIB/POP) \*
(E/PIB) \* (CO2/E) Avec : CO2 : Emission de CO2 POP : la population PIB
: Produit interieur brut E : consommation d'énergie PIB/POP : Produit
interieur brut par habitant E/PIB : Intensité énergétique du PIB CO2/E :
Intensité carbone de l'énergie

```{r}
#Identité de Kaya pour l'ensemble des pays membres de l'OCDE
Kaya_OCDE <-  OCDE_pays %>% filter(Variable %in% c("Émissions de CO2 (kt)","Population, total","PIB réel","Approvisionnements totaux en énergie")) %>% select(-`COU`, -`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 

Kaya_OCDE <- Kaya_OCDE %>%  group_by(Année) %>% summarise(PIB_tot = sum(`PIB réel`, na.rm = TRUE)*1000000, Hab_tot = sum(`Population, total`,na.rm = TRUE), CO2_tot = sum(`Émissions de CO2 (kt)`, na.rm = TRUE), E_tot = sum(`Approvisionnements totaux en énergie`, na.rm = TRUE)) %>% mutate(PIB_hab = `PIB_tot`/`Hab_tot`, IEP_tot = `E_tot`/`PIB_tot`, ICE_tot = `CO2_tot`/`E_tot`)

Kaya_OCDE_growth <- Kaya_OCDE %>% mutate(taux_PIB_hab = ((`PIB_hab` - lag( `PIB_hab`))*100/lag( `PIB_hab`)),taux_CO2 = ((`CO2_tot` - lag( `CO2_tot`))*100 /lag( `CO2_tot`)), taux_POP = ((`Hab_tot` - lag(`Hab_tot`))*100 / `Hab_tot`), taux_IEP = ((`IEP_tot` - lag( `IEP_tot`))*100 /lag( `IEP_tot`)), taux_ICE = ((`ICE_tot` - lag( `ICE_tot`))*100 /lag( `ICE_tot`)))

ggplot(Kaya_OCDE_growth, aes(x = Année)) + geom_bar(aes(y = taux_PIB_hab, fill = "Taux PIB par habitant"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_bar(aes(y = taux_POP, fill = "Taux population"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_bar(aes(y = taux_IEP, fill = "Taux de l'intensité énergétique du PIB"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_bar(aes(y = taux_ICE, fill = "Taux de l'intensité carbone de l'énergie"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_point(aes(y = taux_CO2), color = 'black', size = 2, na.rm = TRUE) + theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5)) +  labs(title = "Identité de Kaya des pays membres de l'OCDE", x = "Année", y = "Taux (%)") + geom_abline(intercept = 0, slope = 0, color = "black") 



#Identité de Kaya pour l'ensemble des pays non membres de l'OCDE
Kaya_non_OCDE <-  non_OCDE_pays %>% filter(Variable %in% c("Émissions de CO2 (kt)","Population, total","PIB réel","Approvisionnements totaux en énergie")) %>% select(-`COU`, -`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 

Kaya_non_OCDE <- Kaya_non_OCDE %>%  group_by(Année) %>% summarise(PIB_tot = sum(`PIB réel`, na.rm = TRUE)*1000000, Hab_tot = sum(`Population, total`,na.rm = TRUE), CO2_tot = sum(`Émissions de CO2 (kt)`, na.rm = TRUE), E_tot = sum(`Approvisionnements totaux en énergie`, na.rm = TRUE)) %>% mutate(PIB_hab = `PIB_tot`/`Hab_tot`, IEP_tot = `E_tot`/`PIB_tot`, ICE_tot = `CO2_tot`/`E_tot`)

Kaya_non_OCDE_growth <- Kaya_non_OCDE %>% mutate(taux_PIB_hab = ((`PIB_hab` - lag( `PIB_hab`))*100/lag( `PIB_hab`)),taux_CO2 = ((`CO2_tot` - lag( `CO2_tot`))*100 /lag( `CO2_tot`)), taux_POP = ((`Hab_tot` - lag(`Hab_tot`))*100 / `Hab_tot`), taux_IEP = ((`IEP_tot` - lag( `IEP_tot`))*100 /lag( `IEP_tot`)), taux_ICE = ((`ICE_tot` - lag( `ICE_tot`))*100 /lag( `ICE_tot`)))

ggplot(Kaya_non_OCDE_growth, aes(x = Année)) + geom_bar(aes(y = taux_PIB_hab, fill = "Taux PIB par habitant"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_bar(aes(y = taux_POP, fill = "Taux population"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_bar(aes(y = taux_IEP, fill = "Taux de l'intensité énergétique du PIB"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_bar(aes(y = taux_ICE, fill = "Taux de l'intensité carbone de l'énergie"), stat ="identity", position = "dodge", na.rm = TRUE) + geom_point(aes(y = taux_CO2), color = 'black', size = 2, na.rm = TRUE) + theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5)) +  labs(title = "Identité de Kaya des pays non membres de l'OCDE", x = "Année", y = "Taux (%)") + geom_abline(intercept = 0, slope = 0, color = "black") 


```

```{r}
#Kaya Table
Kaya_table_OCDE <- Kaya_OCDE_growth %>% select(Année,taux_PIB_hab,taux_CO2,taux_POP,taux_ICE,taux_IEP)

Kaya_OCDE_growth <- Kaya_OCDE %>% mutate(taux_PIB_hab = ((`PIB_hab` - lag( `PIB_hab`))*100/lag( `PIB_hab`)),taux_CO2 = ((`CO2_tot` - lag( `CO2_tot`))*100 /lag( `CO2_tot`)), taux_POP = ((`Hab_tot` - lag(`Hab_tot`))*100 / `Hab_tot`), taux_IEP = ((`IEP_tot` - lag( `IEP_tot`))*100 /lag( `IEP_tot`)), taux_ICE = ((`ICE_tot` - lag( `ICE_tot`))*100 /lag( `ICE_tot`)))
```

*B- vulnérabilité humaine face aux changement climatiques*
L'industrialisation intensives qui a lieu depuis le 19 ieme siècle et la
consommation de masse des 30 glorieuses n'a pas laissé notre planète
indemne. En effet, les catastrophes naturelles se multiplient et nous
sommes totalement vulnérable face à cet nature déchainée.

```{r}
vulnerabilite_OCDE <- OCDE_pays %>% filter(Variable %in% c("Pourcentage de la population exposée aux journées glacées","Pourcentage de la population exposée aux journées chaudes","Pourcentage de la population exposée aux incendies incontrôlés","Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)","Stress hydrique, total des prélèvements d'eau douce en % des ressources internes renouvelables","Population, total")) %>% select(-`COU`, -`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 

vulnarabilite_OCDE_growth <- vulnerabilite_OCDE %>% filter(Pays%in%unique(decoupling_CO2_OCDE$Pays)) %>% group_by(Année, Pays) %>% summarise(population_exposée_aux_journées_glacées = (`Pourcentage de la population exposée aux journées glacées`*`Population, total`),population_exposée_aux_journées_chaudes = (`Pourcentage de la population exposée aux journées chaudes`*`Population, total`), population_exposée_aux_incendies_incontrôlés = (`Pourcentage de la population exposée aux incendies incontrôlés`*`Population, total`), Population = `Population, total`, .groups = 'drop')

vulnarabilite_OCDE_growth <- vulnarabilite_OCDE_growth  %>% group_by(Année) %>% summarise(somme_population_exposée_aux_journées_glacées = sum(`population_exposée_aux_journées_glacées`, na.rm = TRUE),somme_population_exposée_aux_journées_chaudes = sum(`population_exposée_aux_journées_chaudes`, na.rm = TRUE), somme_population_exposée_aux_incendies_incontrôlés = sum(`population_exposée_aux_incendies_incontrôlés`,na.rm = TRUE), somme_Population = sum(`Population`,na.rm = TRUE))

vulnarabilite_OCDE_growth <- vulnarabilite_OCDE_growth %>% mutate(part_population_exposée_aux_journées_glacées = (`somme_population_exposée_aux_journées_glacées`/`somme_Population`), part_population_exposée_aux_journées_chaudes = (`somme_population_exposée_aux_journées_chaudes`/`somme_Population`),part_population_exposée_aux_incendies_incontrôlés = (`somme_population_exposée_aux_incendies_incontrôlés`/`somme_Population`))

vulnarabilite_OCDE_growth<- vulnarabilite_OCDE_growth %>% pivot_longer(cols = c(part_population_exposée_aux_incendies_incontrôlés,part_population_exposée_aux_journées_chaudes,part_population_exposée_aux_journées_glacées), names_to = "Variable", values_to = "Taux") 

ggplot(vulnarabilite_OCDE_growth, aes(x = Année, y = Taux, color = Variable, linetype = Variable, group = Variable)) + geom_point(na.rm = TRUE)  + geom_line(na.rm = TRUE) + labs(title = "Part de la population de l'OCDE exposée aux incendies incontrôlées, \n aux journées chaudes  et aux journées glacées", x = "Année", y = "Taux (%)", color = "Variable") +  theme(axis.text.x=element_text(angle=50, size=8, vjust=0.5)) +   geom_smooth(method = 'loess',formula = 'y ~ x' , alpha = 0.3, linewidth = 0.5, se = FALSE, color = 'black')



```

Au sein des pays membres de l'OCDE nous constatons que la part de la
population exposée aux journées chaudes à particulièrement augmentées.
En effet bien qu'il y ait de fortes variations entre les années, la
tendance montre une nette augmentation entre 1990 et 2020 d'un peu plus
de 25% à un peu moins de 40%. Pour ce qui est de la part de la
populaition exposée aux journées glacées, il n'y a pas eu de fort
changement durant c'est 30 dernières. Enfin, sur la part de la
population exposée aux incendies, il n'y a pas de valeurs avant 2000,
donc on ne peut pas interpréter les valeurs entre 1990 et 2000, de plus
entre 2000 et 2020 on constate une tendance constante. Nous ne possedons
pas de valeurs pour les pays non membres de l'OCDE, toutefois la
variables Sécheresses, inondations, températures extrêmes (en % de la
population, moyenne de 1990 à 2009) nous permet d'effectuer des
comparaisons entre les pays membres et non-membres de l'OCDE

```{r}
#Sécheresses, inondations, températures extrêmes (en % de la population, moyenne de 1990 à 2009)
risque_OCDE <- OCDE_pays %>% filter(Variable %in% c("Sécheresses, inondations, températures extrêmes (en % de la population, moyenne de 1990 à 2009)")) %>% select(-`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 

risque_non_OCDE <- non_OCDE_pays %>% filter(Variable %in% c("Sécheresses, inondations, températures extrêmes (en % de la population, moyenne de 1990 à 2009)")) %>% select(-`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 

risque <- bind_rows(mutate(risque_OCDE, Group = "OCDE"),mutate(risque_non_OCDE, Group = "Non-OCDE"))
risque <- risque %>% filter(Pays%in%unique(risque$Pays)) %>% group_by(Pays, Group, COU) %>% summarise(Secheresses_inondations_temperatures_extreme = `Sécheresses, inondations, températures extrêmes (en % de la population, moyenne de 1990 à 2009)`[Année == 2009], .groups = 'drop')



```

```{r}
ggplot(risque, aes(x = Group, y = Secheresses_inondations_temperatures_extreme, fill = Group)) +
  geom_boxplot(na.rm = TRUE, alpha = 0.8)  +  scale_fill_manual(values = c("Non-OCDE" = "skyblue", "OCDE" = "lightcoral"))  + theme_minimal() + labs(title = "% de la population de chaque pays exposée aux Sécheresses,\n inondations, températures extrêmes (1990-2009)", x = "Groupe", y = "Population de chaque pays exposée aux risques (%)") 
  
```

Par ailleurs, en 2011 certains pays du monde ont été évalué note sur les
progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5
étant la meilleure note)

```{r}

note_progres_non_OCDE <- non_OCDE_pays %>% filter(Variable %in% c("Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)")) %>% select(-`COU`, -`VAR` ,- `Unit`, -`PowerCode`) %>% pivot_longer(cols = c(`1990`,`1991`,`1992`,`1993`,`1994`,`1995`,`1996`,`1997`,`1998`,`1999`,`2000`, `2001`, `2002`, `2003`, `2004`, `2005`, `2006`, `2007`, `2008`, `2009`,`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`, `2020`),  names_to = "Année", values_to = "Value") %>% mutate(Value = as.numeric(Value)) %>% pivot_wider(names_from = Variable, values_from = Value) 


vulnerabilite_OCDE_clean_progres <- drop_na(vulnerabilite_OCDE,`Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)`) %>% select(`Pays`,`Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)`) %>% mutate(Group = "OCDE")

note_progres_non_OCDE <- drop_na(note_progres_non_OCDE,`Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)`) %>% select(`Pays`,`Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)`)  %>% mutate(Group = "Non-OCDE")

note_progres_fusion <- bind_rows(vulnerabilite_OCDE_clean_progres, note_progres_non_OCDE)

ggplot(note_progres_fusion, aes(y = reorder(Pays,`Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)`),x = `Note sur les progrès de réduction des risques de catastrophes (échelle de 1 à 5, 5 étant la meilleure note)`,  fill = Group)) + geom_bar(stat ="identity", position = "dodge", na.rm = TRUE, width =  0.7) +  theme(axis.text.y = element_text(size = 5),plot.title = element_text(hjust = 0.1)) + labs(title = "Note sur les progrès de réduction des risques de catastrophes\n (échelle de 1 à 5, 5 étant la meilleure note)", y = "Pays", x = "note sur les progrès de\n réduction des risques de catastrophes") +  scale_fill_manual(values = c("OCDE" = "blue", "Non-OCDE" = "red")) 




```

ii. Examiner les variables en lien avec les zones en-dessous d'une
    certaine altitudes ou à proximité du niveau de la mer et leur
    vulnérabilité sur la hausse des niveaux des océans.

Superficie des terres dont l'altitude est inférieure à 5 mètres (en % de
la superficie totale des terres) Zones urbaines dont l'altitude est \< à
5 m (% de la superficie totale) Population vivant sur des terres dont
l'altitude est inférieure à 5 mètres (en % de la population totale)
Hauteur moyenne des précipitations (mm par an)

```{r}
# Hauteur moyenne des précipitations (mm par an)

```
